# ============================================
# CD Pipeline - Deploy to Azure Container Instances
# ============================================
name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  ACR_NAME: ytcloneacr8568
  IMAGE_NAME: youtube-clone
  RESOURCE_GROUP: rg-youtubeclone
  CONTAINER_NAME_PROD: youtube-clone-prod
  CONTAINER_NAME_STAGING: youtube-clone-staging

permissions:
  id-token: write
  contents: read

jobs:
  # ----------------------------------------
  # Deploy to Staging (develop branch)
  # ----------------------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop')
    environment:
      name: staging
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to ACI (Staging)
        run: |
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME_STAGING }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:develop-latest \
            --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --dns-name-label ${{ env.CONTAINER_NAME_STAGING }} \
            --ports 80 \
            --os-type Linux \
            --cpu 0.5 \
            --memory 0.5 \
            --restart-policy Always

      - name: Health check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          FQDN=$(az container show --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CONTAINER_NAME_STAGING }} --query "ipAddress.fqdn" -o tsv)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${FQDN}/health || echo "000")
          if [ "$STATUS" -eq 200 ]; then
            echo "✅ Staging deployment healthy at http://${FQDN}"
          else
            echo "⚠️ Health check returned status: $STATUS at http://${FQDN}"
          fi

  # ----------------------------------------
  # Deploy to Production (main branch)
  # ----------------------------------------
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    environment:
      name: production
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to ACI (Production)
        run: |
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME_PROD }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --dns-name-label ${{ env.CONTAINER_NAME_PROD }} \
            --ports 80 \
            --os-type Linux \
            --cpu 0.5 \
            --memory 0.5 \
            --restart-policy Always

      - name: Health check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          FQDN=$(az container show --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CONTAINER_NAME_PROD }} --query "ipAddress.fqdn" -o tsv)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${FQDN}/health || echo "000")
          if [ "$STATUS" -eq 200 ]; then
            echo "✅ Production deployment healthy at http://${FQDN}"
          else
            echo "⚠️ Health check returned status: $STATUS at http://${FQDN}"
          fi
